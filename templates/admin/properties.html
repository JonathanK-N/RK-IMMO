{% extends "admin/base.html" %}

{% block title %}Gestion des Propriétés - Administration RK IMMO{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Gestion des Propriétés</h1>
        <p class="text-gray-600">Gérez votre catalogue de biens immobiliers</p>
    </div>
    <a href="{{ url_for('admin_add_property') }}" 
       class="bg-primary hover:bg-blue-800 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-300">
        <i class="fas fa-plus mr-2"></i>
        Ajouter un Bien
    </a>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Recherche</label>
            <input type="text" 
                   id="search-input"
                   placeholder="Titre, ville, adresse..." 
                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
            <select id="type-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="">Tous types</option>
                <option value="Vente">Vente</option>
                <option value="Location">Location</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
            <select id="category-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="">Toutes catégories</option>
                <option value="Appartement">Appartement</option>
                <option value="Maison">Maison</option>
                <option value="Bureau">Bureau</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
            <select id="status-filter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary focus:border-transparent">
                <option value="">Tous statuts</option>
                <option value="available">Disponible</option>
                <option value="unavailable">Non disponible</option>
                <option value="featured">En vedette</option>
            </select>
        </div>
    </div>
</div>

<!-- Properties Table -->
<div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900">
                {{ properties.total }} bien{{ 's' if properties.total > 1 else '' }}
            </h2>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-600">Afficher:</label>
                    <select class="border border-gray-300 rounded px-2 py-1 text-sm">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <button class="text-gray-500 hover:text-gray-700" title="Actualiser">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
    
    {% if properties.items %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <input type="checkbox" id="select-all" class="rounded border-gray-300">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Bien
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Type
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Prix
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Localisation
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Statut
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="properties-tbody">
                {% for property in properties.items %}
                <tr class="hover:bg-gray-50 transition-colors duration-200 property-row" 
                    data-type="{{ property.property_type }}"
                    data-category="{{ property.category }}"
                    data-available="{{ property.available|lower }}"
                    data-featured="{{ property.featured|lower }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="property-checkbox rounded border-gray-300" value="{{ property.id }}">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <img src="https://images.unsplash.com/photo-1564013799919-ab600027ffc6?ixlib=rb-4.0.3&auto=format&fit=crop&w=100&q=80" 
                                 alt="{{ property.title }}" 
                                 class="w-16 h-12 rounded-lg object-cover mr-4">
                            <div>
                                <div class="text-sm font-medium text-gray-900 line-clamp-2">{{ property.title }}</div>
                                <div class="text-sm text-gray-500">{{ property.surface }} m² • {{ property.bedrooms }} ch.</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                   {% if property.property_type == 'Vente' %}bg-blue-100 text-blue-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ property.property_type }}
                        </span>
                        <div class="text-xs text-gray-500 mt-1">{{ property.category }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ "{:,.0f}".format(property.price) }} €</div>
                        {% if property.property_type == 'Location' %}
                        <div class="text-xs text-gray-500">/mois</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ property.city }}</div>
                        <div class="text-xs text-gray-500">{{ property.address[:30] }}...</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex flex-col space-y-1">
                            {% if property.available %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check-circle mr-1"></i>
                                Disponible
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <i class="fas fa-times-circle mr-1"></i>
                                Non disponible
                            </span>
                            {% endif %}
                            
                            {% if property.featured %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-star mr-1"></i>
                                Vedette
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ property.created_at.strftime('%d/%m/%Y') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex items-center justify-end space-x-2">
                            <a href="{{ url_for('property_detail', id=property.id) }}" 
                               target="_blank"
                               class="text-blue-600 hover:text-blue-900 transition-colors duration-200" 
                               title="Voir">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="text-green-600 hover:text-green-900 transition-colors duration-200 edit-btn" 
                                    data-id="{{ property.id }}"
                                    title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-yellow-600 hover:text-yellow-900 transition-colors duration-200 toggle-featured-btn" 
                                    data-id="{{ property.id }}"
                                    data-featured="{{ property.featured|lower }}"
                                    title="Basculer vedette">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-900 transition-colors duration-200 delete-btn" 
                                    data-id="{{ property.id }}"
                                    title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if properties.pages > 1 %}
    <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if properties.has_prev %}
                <a href="{{ url_for('admin_properties', page=properties.prev_num) }}" 
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Précédent
                </a>
                {% endif %}
                {% if properties.has_next %}
                <a href="{{ url_for('admin_properties', page=properties.next_num) }}" 
                   class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Suivant
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Affichage de <span class="font-medium">{{ (properties.page - 1) * properties.per_page + 1 }}</span>
                        à <span class="font-medium">{{ properties.page * properties.per_page if properties.page * properties.per_page < properties.total else properties.total }}</span>
                        sur <span class="font-medium">{{ properties.total }}</span> résultats
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        {% if properties.has_prev %}
                        <a href="{{ url_for('admin_properties', page=properties.prev_num) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% for page_num in properties.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != properties.page %}
                                <a href="{{ url_for('admin_properties', page=page_num) }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                                {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-primary text-sm font-medium text-white">
                                    {{ page_num }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if properties.has_next %}
                        <a href="{{ url_for('admin_properties', page=properties.next_num) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <i class="fas fa-home text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucun bien trouvé</h3>
        <p class="text-gray-600 mb-8">Commencez par ajouter votre premier bien immobilier</p>
        <a href="{{ url_for('admin_add_property') }}" 
           class="bg-primary hover:bg-blue-800 text-white px-6 py-3 rounded-lg font-semibold transition-colors duration-300">
            <i class="fas fa-plus mr-2"></i>
            Ajouter un Bien
        </a>
    </div>
    {% endif %}
</div>

<!-- Bulk Actions Bar (Hidden by default) -->
<div id="bulk-actions-bar" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-2xl border px-6 py-4 hidden">
    <div class="flex items-center space-x-4">
        <span class="text-sm font-medium text-gray-700">
            <span id="selected-count">0</span> bien(s) sélectionné(s)
        </span>
        <div class="flex space-x-2">
            <button id="bulk-featured" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-300">
                <i class="fas fa-star mr-1"></i>
                Mettre en vedette
            </button>
            <button id="bulk-available" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-300">
                <i class="fas fa-check mr-1"></i>
                Rendre disponible
            </button>
            <button id="bulk-delete" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors duration-300">
                <i class="fas fa-trash mr-1"></i>
                Supprimer
            </button>
        </div>
        <button id="clear-selection" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Search and filter functionality
const searchInput = document.getElementById('search-input');
const typeFilter = document.getElementById('type-filter');
const categoryFilter = document.getElementById('category-filter');
const statusFilter = document.getElementById('status-filter');
const propertyRows = document.querySelectorAll('.property-row');

function filterProperties() {
    const searchTerm = searchInput.value.toLowerCase();
    const typeValue = typeFilter.value;
    const categoryValue = categoryFilter.value;
    const statusValue = statusFilter.value;
    
    propertyRows.forEach(row => {
        const title = row.querySelector('.text-sm.font-medium').textContent.toLowerCase();
        const type = row.dataset.type;
        const category = row.dataset.category;
        const available = row.dataset.available;
        const featured = row.dataset.featured;
        
        let show = true;
        
        // Search filter
        if (searchTerm && !title.includes(searchTerm)) {
            show = false;
        }
        
        // Type filter
        if (typeValue && type !== typeValue) {
            show = false;
        }
        
        // Category filter
        if (categoryValue && category !== categoryValue) {
            show = false;
        }
        
        // Status filter
        if (statusValue) {
            if (statusValue === 'available' && available !== 'true') {
                show = false;
            } else if (statusValue === 'unavailable' && available !== 'false') {
                show = false;
            } else if (statusValue === 'featured' && featured !== 'true') {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// Add event listeners for filters
[searchInput, typeFilter, categoryFilter, statusFilter].forEach(element => {
    element.addEventListener('input', filterProperties);
    element.addEventListener('change', filterProperties);
});

// Bulk selection functionality
const selectAllCheckbox = document.getElementById('select-all');
const propertyCheckboxes = document.querySelectorAll('.property-checkbox');
const bulkActionsBar = document.getElementById('bulk-actions-bar');
const selectedCountSpan = document.getElementById('selected-count');

function updateBulkActions() {
    const selectedCheckboxes = document.querySelectorAll('.property-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    selectedCountSpan.textContent = count;
    
    if (count > 0) {
        bulkActionsBar.classList.remove('hidden');
    } else {
        bulkActionsBar.classList.add('hidden');
    }
    
    // Update select all checkbox
    selectAllCheckbox.indeterminate = count > 0 && count < propertyCheckboxes.length;
    selectAllCheckbox.checked = count === propertyCheckboxes.length;
}

// Select all functionality
selectAllCheckbox.addEventListener('change', function() {
    propertyCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateBulkActions();
});

// Individual checkbox functionality
propertyCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActions);
});

// Clear selection
document.getElementById('clear-selection').addEventListener('click', function() {
    propertyCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    updateBulkActions();
});

// Action buttons
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const propertyId = this.dataset.id;
        if (confirm('Êtes-vous sûr de vouloir supprimer ce bien ?')) {
            // Implement delete functionality
            console.log('Delete property:', propertyId);
        }
    });
});

document.querySelectorAll('.toggle-featured-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const propertyId = this.dataset.id;
        const isFeatured = this.dataset.featured === 'true';
        
        // Implement toggle featured functionality
        console.log('Toggle featured for property:', propertyId, 'Current:', isFeatured);
    });
});

// Bulk actions
document.getElementById('bulk-delete').addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.property-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length > 0 && confirm(`Êtes-vous sûr de vouloir supprimer ${selectedIds.length} bien(s) ?`)) {
        console.log('Bulk delete:', selectedIds);
    }
});

document.getElementById('bulk-featured').addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.property-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length > 0) {
        console.log('Bulk set featured:', selectedIds);
    }
});

document.getElementById('bulk-available').addEventListener('click', function() {
    const selectedIds = Array.from(document.querySelectorAll('.property-checkbox:checked')).map(cb => cb.value);
    if (selectedIds.length > 0) {
        console.log('Bulk set available:', selectedIds);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + A to select all
    if ((e.ctrlKey || e.metaKey) && e.key === 'a' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        selectAllCheckbox.click();
    }
    
    // Delete key to delete selected
    if (e.key === 'Delete') {
        const selectedIds = Array.from(document.querySelectorAll('.property-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            document.getElementById('bulk-delete').click();
        }
    }
});
</script>
{% endblock %}